<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>LINEé¢¨CHAT</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/earlyaccess/hannari.css" rel="stylesheet">
</head>
<body>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

<div class="box">
    <header id="title">ã­ã“ã«ãªã‚Œã‚‹ãƒãƒ£ãƒƒãƒˆ</header>
    <div class="wrapper">
        <div id="output" style="display: flex; flex-direction: column; overflow: auto; height: 500px;">
            <ul id="chat-area">
            <li>
            <div class="balloon balloon-r"><p class="say say-r">ã“ã‚“ã«ã¡ã¯</p></div>
            </li>
            <li>
            <div class="balloon"><p class="say">ã“ã“ã§ã¯çŒ«ã«ãªã‚Œã¾ã™ã€‚</p></div>
            <p class="say">å¥½ããªã“ã¨ã‚’è©±ã—ã¾ã—ã‚‡ã†</p>
            </li>
            </ul>
        </div>
        <div>ãŠãªã¾ãˆ<input type="text" id="uname"></div>
        <textarea id="text" cols="25" rows="3"></textarea>
        <button id="send">é€ä¿¡</button>
    </div>
    
</div>
<!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

<!--** ä»¥ä¸‹Firebase **-->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, set, update, remove, onChildAdded, onChildChanged, onChildRemoved } //ä½¿ã†æ©Ÿèƒ½ã‚’æŒ‡å®š
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"; //ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®š
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "",
        authDomain: "chat-gs004.firebaseapp.com",
        projectId: "chat-gs004",
        storageBucket: "chat-gs004.appspot.com",
        messagingSenderId: "1035158653589",
        appId: "1:1035158653589:web:82bd3a4e78fc3b28b6299c"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); //RealTimeDBã«æ¥ç¶šã™ã‚‹
    const dbRef = ref(db,"chat"); //DBå†…ã®éšå±¤ã‚’æŒ‡å®šã™ã‚‹

    //é€ä¿¡
    $("#send").on("click",function(){ //ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰
        const msg = { //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å…¥ã‚Œã‚‹
            uname : $("#uname").val(), 
            text : $("#text").val(),
        }
        const newPostRef = push(dbRef); //ãƒãƒ£ãƒƒãƒˆã«ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹éç¨‹ãŒé‡è¦
        set(newPostRef,msg);
    });

    //å—ä¿¡
    onChildAdded(dbRef,function(data){ //DBã«ãƒ‡ãƒ¼ã‚¿ã«å…¥ã£ã¦ããŸã‚‰
        const msg = data.val(); //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°ã‚’å±•é–‹ã™ã‚‹é–¢æ•°
        const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã¯å‰Šé™¤ãƒ»æ›´æ–°ã®æŒ‡å®šã«å¿…é ˆï¼
        let h = '<ul id="' + key + '">'; //keyã¯å‰Šé™¤ã®ãŸã‚ã«å¿…è¦
            h += '<li class="balloon balloon-r">';
            h += msg.uname;
            h += '<span>ã­ã“</span>';
            h += '</li>';
            h += '<li class="say say-r">';
            h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>'; //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ã•ã‚ŒãŸã‚‰idåã‚’å¤‰æ›´
            h += '<span>ã§ã™ã«ã‚ƒ</span>';
            h += '<span class="remove" data-key="' + key +'">ğŸš®</span>';
            h += '<span class="update" data-key="' + key +'">ğŸ†™</span>';
            h += '</li>';
            h += '</ul>';
            $("#output").append(h);
    });

    //å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click", ".remove", function(){ //outputã®ä¸­ã®removeã‚¯ãƒ©ã‚¹ã‚’ç›£è¦–ã™ã‚‹
        const key = $(this).attr("data-key"); //thisã¨ã¯æŠ¼ã—ãŸå ´æ‰€ã ã‘ã‚’æŒ‡å®šã™ã‚‹ã€attrã¯å±æ€§ã®ã“ã¨ã€å±æ€§ã‚’æŒ‡å®šã§ãã‚‹
        const remove_item = ref(db,"chat/" + key); //ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã€å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹é–¢æ•°
        remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
    });

    //æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click", ".update", function (){ //ouputã®ä¸­ã®updateã‚¯ãƒ©ã‚¹ã‚’ç›£è¦–ã™ã‚‹
        const key = $(this).attr("data-key");
        update(ref(db, "chat/"+key), {
            text: $("#" + key + '_update').html()
    });

});

    //å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ

    onChildRemoved(dbRef, (data) => {
        $("#" + data.key).remove(); //å¯¾è±¡ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
    });

    //æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    onChildChanged(dbRef, (data) => {
        $("#"+data.key+'_update').html(data.val().text);
        $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
    });

</script>


</body>
</html>
